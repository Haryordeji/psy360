<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Cognition Experiment</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }

        #container {
            background: white;
            padding: 60px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            /* Wider container to prevent text wrapping */
            width: 900px;
            max-width: 95%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .hidden { display: none !important; }

        h1 { margin-bottom: 20px; font-size: 32px; }
        p { font-size: 20px; line-height: 1.6; color: #555; }

        .stimulus {
            font-size: 56px;
            font-weight: bold;
            margin-bottom: 40px;
            font-family: monospace;
            white-space: nowrap; /* PREVENTS WRAPPING */
            letter-spacing: -1px;
        }

        .fixation {
            font-size: 80px;
            color: #333;
        }

        input[type="number"] {
            font-size: 32px;
            padding: 15px;
            width: 200px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        input:focus {
            border-color: #007bff;
        }

        /* Remove arrows from number input */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        button {
            padding: 15px 30px;
            font-size: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background-color: #0056b3; }

    </style>
</head>
<body>

    <div id="container">
        <!-- SCREEN 1: WELCOME -->
        <div id="screen-welcome">
            <h1>Arithmetic Experiment</h1>
            <p>You will be presented with a series of addition problems.</p>
            <p>Some will be in <b>digits</b> (e.g., 42 + 31) and some in <b>words</b> (e.g., forty-two + thirty-one).</p>
            <p>Please type the answer and press <b>ENTER</b> as quickly and accurately as possible.</p>
            <br>
            <button onclick="startExperiment()">Start Experiment</button>
        </div>

        <!-- SCREEN 2: FIXATION -->
        <div id="screen-fixation" class="hidden">
            <div class="fixation">+</div>
        </div>

        <!-- SCREEN 3: STIMULUS -->
        <div id="screen-trial" class="hidden">
            <div id="stimulus-display" class="stimulus"></div>
            <input type="number" id="answer-input" autocomplete="off">
        </div>

        <!-- SCREEN 4: END -->
        <div id="screen-end" class="hidden">
            <h1>Experiment Complete</h1>
            <p>Thank you for your participation.</p>
            <p>Your data file should download automatically.</p>
            <p>Please upload the <b>.csv</b> file to the Google Form provided.</p>
            <br>
            <button onclick="downloadCSV()">Download Again (if failed)</button>
        </div>
    </div>

    <script>
        // --- 1. BALANCED STIMULI DATABASE (MATCHED-PAIR DESIGN) ---
        // We use 10 specific target sums: [53, 56, 62, 67, 74, 76, 83, 85, 88, 94]
        // This ensures the "Problem Size Effect" is perfectly controlled across conditions
        // without repeating the exact same problem text.

        const rawStimuli = [
            // --- CONDITION 1: DIGIT / NO-CARRY ---
            { n1: 21, n2: 32, format: 'digit', carry: 'no', condition: 1 }, // Sum 53
            { n1: 22, n2: 34, format: 'digit', carry: 'no', condition: 1 }, // Sum 56
            { n1: 41, n2: 21, format: 'digit', carry: 'no', condition: 1 }, // Sum 62
            { n1: 23, n2: 44, format: 'digit', carry: 'no', condition: 1 }, // Sum 67
            { n1: 32, n2: 42, format: 'digit', carry: 'no', condition: 1 }, // Sum 74
            { n1: 52, n2: 24, format: 'digit', carry: 'no', condition: 1 }, // Sum 76
            { n1: 51, n2: 32, format: 'digit', carry: 'no', condition: 1 }, // Sum 83
            { n1: 62, n2: 23, format: 'digit', carry: 'no', condition: 1 }, // Sum 85
            { n1: 64, n2: 24, format: 'digit', carry: 'no', condition: 1 }, // Sum 88
            { n1: 72, n2: 22, format: 'digit', carry: 'no', condition: 1 }, // Sum 94

            // --- CONDITION 2: DIGIT / CARRY ---
            { n1: 26, n2: 27, format: 'digit', carry: 'yes', condition: 2 }, // Sum 53
            { n1: 27, n2: 29, format: 'digit', carry: 'yes', condition: 2 }, // Sum 56
            { n1: 27, n2: 35, format: 'digit', carry: 'yes', condition: 2 }, // Sum 62
            { n1: 28, n2: 39, format: 'digit', carry: 'yes', condition: 2 }, // Sum 67
            { n1: 36, n2: 38, format: 'digit', carry: 'yes', condition: 2 }, // Sum 74
            { n1: 39, n2: 37, format: 'digit', carry: 'yes', condition: 2 }, // Sum 76
            { n1: 45, n2: 38, format: 'digit', carry: 'yes', condition: 2 }, // Sum 83
            { n1: 59, n2: 26, format: 'digit', carry: 'yes', condition: 2 }, // Sum 85
            { n1: 49, n2: 39, format: 'digit', carry: 'yes', condition: 2 }, // Sum 88
            { n1: 48, n2: 46, format: 'digit', carry: 'yes', condition: 2 }, // Sum 94

            // --- CONDITION 3: WORD / NO-CARRY ---
            // Target sums match Condition 1, but we use different addends to prevent memory recall
            { n1: 41, n2: 12, format: 'word', carry: 'no', condition: 3 }, // Sum 53
            { n1: 42, n2: 14, format: 'word', carry: 'no', condition: 3 }, // Sum 56
            { n1: 51, n2: 11, format: 'word', carry: 'no', condition: 3 }, // Sum 62
            { n1: 33, n2: 34, format: 'word', carry: 'no', condition: 3 }, // Sum 67
            { n1: 52, n2: 22, format: 'word', carry: 'no', condition: 3 }, // Sum 74
            { n1: 62, n2: 14, format: 'word', carry: 'no', condition: 3 }, // Sum 76
            { n1: 61, n2: 22, format: 'word', carry: 'no', condition: 3 }, // Sum 83
            { n1: 52, n2: 33, format: 'word', carry: 'no', condition: 3 }, // Sum 85
            { n1: 54, n2: 34, format: 'word', carry: 'no', condition: 3 }, // Sum 88
            { n1: 62, n2: 32, format: 'word', carry: 'no', condition: 3 }, // Sum 94

            // --- CONDITION 4: WORD / CARRY ---
            // Target sums match Condition 2, but different addends
            { n1: 25, n2: 28, format: 'word', carry: 'yes', condition: 4 }, // Sum 53
            { n1: 38, n2: 18, format: 'word', carry: 'yes', condition: 4 }, // Sum 56
            { n1: 28, n2: 34, format: 'word', carry: 'yes', condition: 4 }, // Sum 62
            { n1: 29, n2: 38, format: 'word', carry: 'yes', condition: 4 }, // Sum 67
            { n1: 47, n2: 27, format: 'word', carry: 'yes', condition: 4 }, // Sum 74
            { n1: 48, n2: 28, format: 'word', carry: 'yes', condition: 4 }, // Sum 76
            { n1: 46, n2: 37, format: 'word', carry: 'yes', condition: 4 }, // Sum 83
            { n1: 48, n2: 37, format: 'word', carry: 'yes', condition: 4 }, // Sum 85
            { n1: 59, n2: 29, format: 'word', carry: 'yes', condition: 4 }, // Sum 88
            { n1: 57, n2: 37, format: 'word', carry: 'yes', condition: 4 }, // Sum 94
        ];

        // Helper: Number to Word converter
        const numToWords = {
            11: "eleven", 12: "twelve", 14: "fourteen", 18: "eighteen",
            21: "twenty-one", 22: "twenty-two", 23: "twenty-three", 24: "twenty-four", 25: "twenty-five", 26: "twenty-six", 27: "twenty-seven", 28: "twenty-eight", 29: "twenty-nine",
            32: "thirty-two", 33: "thirty-three", 34: "thirty-four", 35: "thirty-five", 36: "thirty-six", 37: "thirty-seven", 38: "thirty-eight", 39: "thirty-nine",
            41: "forty-one", 42: "forty-two", 44: "forty-four", 45: "forty-five", 46: "forty-six", 47: "forty-seven", 48: "forty-eight", 49: "forty-nine",
            51: "fifty-one", 52: "fifty-two", 54: "fifty-four", 57: "fifty-seven", 59: "fifty-nine",
            61: "sixty-one", 62: "sixty-two", 64: "sixty-four",
            72: "seventy-two"
        };

        // --- 2. EXPERIMENT STATE ---
        let trials = [];
        let currentTrialIndex = 0;
        let trialStartTime = 0;
        let participantData = [];
        let hasEdited = false;
        const subjectID = 'Sub_' + Math.floor(Math.random() * 10000);

        // --- 3. FUNCTIONS ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startExperiment() {
            // Randomize order
            trials = shuffle([...rawStimuli]);
            document.getElementById('screen-welcome').classList.add('hidden');
            showFixation();
        }

        function showFixation() {
            document.getElementById('screen-fixation').classList.remove('hidden');
            document.getElementById('screen-trial').classList.add('hidden');
            
            // 500ms fixation cross
            setTimeout(() => {
                document.getElementById('screen-fixation').classList.add('hidden');
                showTrial();
            }, 500);
        }

        function showTrial() {
            if (currentTrialIndex >= trials.length) {
                endExperiment();
                return;
            }

            const trial = trials[currentTrialIndex];
            const displayEl = document.getElementById('stimulus-display');
            const inputEl = document.getElementById('answer-input');

            // Format Logic
            if (trial.format === 'digit') {
                displayEl.innerText = `${trial.n1} + ${trial.n2}`;
            } else {
                // Word format conversion
                const w1 = numToWords[trial.n1] || trial.n1; // Fallback if typo
                const w2 = numToWords[trial.n2] || trial.n2;
                displayEl.innerText = `${w1} + ${w2}`;
            }

            // Reset input
            inputEl.value = '';
            hasEdited = false;
            document.getElementById('screen-trial').classList.remove('hidden');
            inputEl.focus();

            // START TIMER
            trialStartTime = performance.now();
        }

        function checkEdit(e) {
            // If they press Backspace or Delete, mark trial as dirty
            if (e.key === "Backspace" || e.key === "Delete") {
                hasEdited = true;
            }
        }

        function handleInput(e) {
            if (e.key === 'Enter') {
                const inputEl = document.getElementById('answer-input');
                const userAnswer = parseInt(inputEl.value);

                if (isNaN(userAnswer)) return; // Don't submit empty

                const endTime = performance.now();
                const rt = endTime - trialStartTime;
                const trial = trials[currentTrialIndex];
                const correctAnswer = trial.n1 + trial.n2;
                const isCorrect = (userAnswer === correctAnswer) ? 1 : 0;

                // Save Data
                participantData.push({
                    subject: subjectID,
                    condition_code: trial.condition,
                    format: trial.format,
                    complexity: trial.carry,
                    n1: trial.n1,
                    n2: trial.n2,
                    correct_answer: correctAnswer,
                    user_answer: userAnswer,
                    accuracy: isCorrect,
                    rt_ms: Math.round(rt),
                    was_edited: hasEdited ? 1 : 0
                });

                // Next Trial
                currentTrialIndex++;
                showFixation();
            }
        }

        function endExperiment() {
            document.getElementById('screen-trial').classList.add('hidden');
            document.getElementById('screen-end').classList.remove('hidden');
            downloadCSV();
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "SubjectID,ConditionCode,Format,Complexity,N1,N2,CorrectAnswer,UserAnswer,Accuracy,RT_ms,WasEdited\n";

            participantData.forEach(row => {
                csvContent += `${row.subject},${row.condition_code},${row.format},${row.complexity},${row.n1},${row.n2},${row.correct_answer},${row.user_answer},${row.accuracy},${row.rt_ms},${row.was_edited}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `results_${subjectID}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('answer-input').addEventListener('keydown', checkEdit);
        document.getElementById('answer-input').addEventListener('keypress', handleInput);

    </script>
</body>
</html>